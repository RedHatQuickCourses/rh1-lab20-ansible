= Troubleshoot rulebook using CURL.

== Validate the rules in the rulebooks


Access the node1 node via ssh:

Access the 01-lab folder

[source,bash]
----
[lab-user@bastion ~]$ ssh node1 
[ec2-user@node1 ~]$ cd 01-lab/
[ec2-user@node1 01-lab]$ ll
total 12
-rw-r--r--. 1 ec2-user ec2-user  86 Nov 18 13:57 hello-rh1.yml
-rw-r--r--. 1 ec2-user ec2-user  61 Nov 18 13:57 inventory.yml
-rw-r--r--. 1 ec2-user ec2-user 288 Nov 18 13:57 webhook-example.yml
----

In the terminal where you created the files. Run ansible-rulebook:

[source,bash]
----
ansible-rulebook --rulebook webhook-example.yml -i inventory.yml --verbose  --print-events 
----

[source,bash]
----
[ec2-user@node1 01-lab]$ ansible-rulebook --rulebook webhook-example.yml -i inventory.yml --verbose  --print-events 
2024-11-18 20:00:48,035 - ansible_rulebook.app - INFO - Starting sources
2024-11-18 20:00:48,035 - ansible_rulebook.app - INFO - Starting rules
2024-11-18 20:00:48,036 - drools.ruleset - INFO - Using jar: /usr/lib/python3.9/site-packages/drools/jars/drools-ansible-rulebook-integration-runtime-1.0.6.Final-redhat-00001.jar
2024-11-18 20:00:49 152 [main] INFO org.drools.ansible.rulebook.integration.api.rulesengine.AbstractRulesEvaluator - Start automatic pseudo clock with a tick every 100 milliseconds
2024-11-18 20:00:49,184 - ansible_rulebook.engine - INFO - load source ansible.eda.webhook
2024-11-18 20:00:49,983 - ansible_rulebook.engine - INFO - loading source filter eda.builtin.insert_meta_info
2024-11-18 20:00:50,748 - ansible_rulebook.engine - INFO - Waiting for all ruleset tasks to end
2024-11-18 20:00:50,749 - ansible_rulebook.rule_set_runner - INFO - Waiting for actions on events from Listen for events on a webhook
2024-11-18 20:00:50,749 - ansible_rulebook.rule_set_runner - INFO - Waiting for events, ruleset: Listen for events on a webhook
2024-11-18 20:00:50 751 [drools-async-evaluator-thread] INFO org.drools.ansible.rulebook.integration.api.io.RuleExecutorChannel - Async channel connected
----

In another terminal, run the curl command:


[source,bash]
----
curl -H 'Content-Type: application/json' -d '{"event_name:" "Hello" }' node1:5000/endpoint
----

When you send the curl above, it will show the message below:


[source,bash]
----

In the terminal where you executed the rulebook command. You will get this output:


                          'Content-Length': '24',
                               'Content-Type': 'application/json',
                               'Host': 'localhost:5000',
                               'User-Agent': 'curl/7.61.1'},
                'received_at': '2024-10-21T01:50:01.956477Z',
                'source': {   'name': 'ansible.eda.webhook',
                              'type': 'ansible.eda.webhook'},
                'uuid': '16fd293e-342a-4fd8-9203-196ff207239b'},
    'payload': {'event_name': 'Hello'}}
2024-10-20 22:50:01 980 [main] INFO org.drools.ansible.rulebook.integration.api.rulesengine.RegisterOnlyAgendaFilter - Activation of effective rule "Hello RH1" with facts: {m={payload={event_name=Hello}, meta={headers={Accept=*/*, User-Agent=curl/7.61.1, Host=localhost:5000, Content-Length=24, Content-Type=application/json}, endpoint=endpoint, received_at=2024-10-21T01:50:01.956477Z, source={name=ansible.eda.webhook, type=ansible.eda.webhook}, uuid=16fd293e-342a-4fd8-9203-196ff207239b}}}
2024-10-20 22:50:01,983 - ansible_rulebook.rule_generator - INFO - calling Hello RH1
2024-10-20 22:50:01,984 - ansible_rulebook.rule_set_runner - INFO - call_action run_playbook
2024-10-20 22:50:01,984 - ansible_rulebook.rule_set_runner - INFO - substitute_variables [{'name': 'hello-rh1.yml'}] [{'event': {'payload': {'event_name': 'Hello'}, 'meta': {'headers': {'Accept': '*/*', 'User-Agent': 'curl/7.61.1', 'Host': 'localhost:5000', 'Content-Length': '24', 'Content-Type': 'application/json'}, 'endpoint': 'endpoint', 'received_at': '2024-10-21T01:50:01.956477Z', 'source': {'name': 'ansible.eda.webhook', 'type': 'ansible.eda.webhook'}, 'uuid': '16fd293e-342a-4fd8-9203-196ff207239b'}}}]
2024-10-20 22:50:01,984 - ansible_rulebook.rule_set_runner - INFO - action args: {'name': 'hello-rh1.yml'}
2024-10-20 22:50:01,984 - ansible_rulebook.builtin - INFO - running Ansible playbook: hello-rh1.yml
2024-10-20 22:50:01,985 - ansible_rulebook.builtin - INFO - ruleset: Listen for events on a webhook, rule: Hello RH1
2024-10-20 22:50:01,985 - ansible_rulebook.builtin - INFO - Calling Ansible runner

PLAY [localhost] ***************************************************************

TASK [Gathering Facts] *********************************************************
ok: [localhost]

TASK [debug] *******************************************************************
ok: [localhost] => {
    "msg": "Hello RH1"
}

PLAY RECAP *********************************************************************
localhost                  : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
2024-10-20 22:50:13,309 - ansible_rulebook.builtin - INFO - Ansible Runner Queue task cancelled
2024-10-20 22:50:13,311 - ansible_rulebook.builtin - INFO - Playbook rc: 0, status: successful
2024-10-20 22:50:13,312 - ansible_rulebook.rule_set_runner - INFO - Task action::run_playbook::Listen for events on a webhook::Hello RH1 finished, active actions 0
----

