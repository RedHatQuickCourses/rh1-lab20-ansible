= Troubleshoot rulebook using CURL and extra_vars

[#in_this_bfx]
== Whatâ€™s in this break-fix?

FIXME: 

Short description about this break-fix activity

Steps to be followed:

. Step 1
+
[source,bash]
----
command to be executed in the lab
----
+
.Output
----
Output displayed by the command
----

. Step 2

.. sub-step 2.1

.. sub-step 2.2

. Step 3


[source,bash]
----
[lab-user@bastion ~]$ ssh node1 
[ec2-user@node1 ~]$ cd 02-lab/
[ec2-user@node1 02-lab]$ ll
total 12
-rw-r--r--. 1 ec2-user ec2-user  86 Nov 18 13:57 hello-rh1.yml
-rw-r--r--. 1 ec2-user ec2-user  61 Nov 18 13:57 inventory.yml
-rw-r--r--. 1 ec2-user ec2-user 288 Nov 18 13:57 webhook-example.yml
----

In the terminal where you created the files. Run ansible-rulebook:


[source,bash]
----
ansible-rulebook --rulebook webhook-example.yml -i inventory.yml --verbose  --print-events
----



[source,bash]
----
[ec2-user@node1 02-lab]$ ansible-rulebook --rulebook webhook-example.yml -i inventory.yml --verbose  --print-events 
2024-11-18 20:15:27,185 - ansible_rulebook.app - INFO - Starting sources
2024-11-18 20:15:27,186 - ansible_rulebook.app - INFO - Starting rules
2024-11-18 20:15:27,187 - drools.ruleset - INFO - Using jar: /usr/lib/python3.9/site-packages/drools/jars/drools-ansible-rulebook-integration-runtime-1.0.6.Final-redhat-00001.jar
2024-11-18 20:15:28 511 [main] INFO org.drools.ansible.rulebook.integration.api.rulesengine.AbstractRulesEvaluator - Start automatic pseudo clock with a tick every 100 milliseconds
2024-11-18 20:15:28,544 - ansible_rulebook.engine - INFO - load source ansible.eda.webhook
2024-11-18 20:15:29,415 - ansible_rulebook.engine - INFO - loading source filter eda.builtin.insert_meta_info
2024-11-18 20:15:30,234 - ansible_rulebook.engine - INFO - Waiting for all ruleset tasks to end
2024-11-18 20:15:30,235 - ansible_rulebook.rule_set_runner - INFO - Waiting for actions on events from Listen for events on a webhook
2024-11-18 20:15:30,235 - ansible_rulebook.rule_set_runner - INFO - Waiting for events, ruleset: Listen for events on a webhook
2024-11-18 20:15:30 236 [drools-async-evaluator-thread] INFO org.drools.ansible.rulebook.integration.api.io.RuleExecutorChannel - Async channel connected

----

In another terminal, run the curl command:

[source,bash]
----
  curl -H 'Content-Type: application/json' -d '{"event_name": "Hello", "host_host": "node1" }' node1:5000/endpoint
----

In the terminal where you executed the rulebook command. You will get this output:

Now, You have two vars: event_name and host_host.


[source,bash]
----
2024-10-22 15:05:30,506 - ansible_rulebook.app - INFO - Starting sources
2024-10-22 15:05:30,506 - ansible_rulebook.app - INFO - Starting rules
2024-10-22 15:05:30,506 - ansible_rulebook.engine - INFO - run_ruleset
2024-10-22 15:05:30,506 - drools.ruleset - INFO - Using jar: /usr/local/lib/python3.9/site-packages/drools/jars/drools-ansible-rulebook-integration-runtime-1.0.2-SNAPSHOT.jar
2024-10-22 15:05:30 841 [main] INFO org.drools.ansible.rulebook.integration.api.rulesengine.AbstractRulesEvaluator - Start automatic pseudo clock with a tick every 100 milliseconds
2024-10-22 15:05:30,844 - ansible_rulebook.engine - INFO - ruleset define: {"name": "Listen for events on a webhook", "hosts": ["all"], "sources": [{"EventSource": {"name": "ansible.eda.webhook", "source_name": "ansible.eda.webhook", "source_args": {"host": "0.0.0.0", "port": 5000}, "source_filters": []}}], "rules": [{"Rule": {"name": "Hello RH1", "condition": {"AllCondition": [{"EqualsExpression": {"lhs": {"Event": "payload.event_name"}, "rhs": {"String": "Hello"}}}]}, "actions": [{"Action": {"action": "run_playbook", "action_args": {"name": "hello-rh1.yml", "extra_vars": {"hosts_update": "{{ event.payload.host_host }}"}}}}], "enabled": true}}]}
2024-10-22 15:05:30,852 - ansible_rulebook.engine - INFO - load source
2024-10-22 15:05:31,061 - ansible_rulebook.engine - INFO - load source filters
2024-10-22 15:05:31,061 - ansible_rulebook.engine - INFO - loading eda.builtin.insert_meta_info
2024-10-22 15:05:31,260 - ansible_rulebook.engine - INFO - Calling main in ansible.eda.webhook
2024-10-22 15:05:31,262 - ansible_rulebook.engine - INFO - Waiting for all ruleset tasks to end
2024-10-22 15:05:31,262 - ansible_rulebook.rule_set_runner - INFO - Waiting for actions on events from Listen for events on a webhook
2024-10-22 15:05:31,262 - ansible_rulebook.rule_set_runner - INFO - Waiting for events, ruleset: Listen for events on a webhook
2024-10-22 15:05:31 262 [drools-async-evaluator-thread] INFO org.drools.ansible.rulebook.integration.api.io.RuleExecutorChannel - Async channel connected
2024-10-22 15:07:21,844 - aiohttp.access - INFO - 127.0.0.1 [22/Oct/2024:18:07:21 +0000] "POST /endpoint HTTP/1.1" 200 158 "-" "curl/7.61.1"
{   'meta': {   'endpoint': 'endpoint',
                'headers': {   'Accept': '*/*',
                               'Content-Length': '65',
                               'Content-Type': 'application/json',
                               'Host': 'localhost:5000',
                               'User-Agent': 'curl/7.61.1'},
                'received_at': '2024-10-22T18:07:21.843955Z',
                'source': {   'name': 'ansible.eda.webhook',
                              'type': 'ansible.eda.webhook'},
                'uuid': 'f27e21d6-dd63-4549-bd78-f9b93f454a4c'},
    'payload': {'event_name': 'Hello', 'host_host': 'gitlab.lnx.example.local'}}
2024-10-22 15:07:21 864 [main] INFO org.drools.ansible.rulebook.integration.api.rulesengine.RegisterOnlyAgendaFilter - Activation of effective rule "Hello RH1" with facts: {m={payload={host_host=gitlab.lnx.example.local, event_name=Hello}, meta={headers={Accept=*/*, User-Agent=curl/7.61.1, Host=localhost:5000, Content-Length=65, Content-Type=application/json}, endpoint=endpoint, received_at=2024-10-22T18:07:21.843955Z, source={name=ansible.eda.webhook, type=ansible.eda.webhook}, uuid=f27e21d6-dd63-4549-bd78-f9b93f454a4c}}}
2024-10-22 15:07:21,870 - ansible_rulebook.rule_generator - INFO - calling Hello RH1
2024-10-22 15:07:21,870 - ansible_rulebook.rule_set_runner - INFO - call_action run_playbook
2024-10-22 15:07:21,870 - ansible_rulebook.rule_set_runner - INFO - substitute_variables [{'name': 'hello-rh1.yml', 'extra_vars': {'hosts_update': '{{ event.payload.host_host }}'}}] [{'event': {'payload': {'host_host': 'gitlab.lnx.example.local', 'event_name': 'Hello'}, 'meta': {'headers': {'Accept': '*/*', 'User-Agent': 'curl/7.61.1', 'Host': 'localhost:5000', 'Content-Length': '65', 'Content-Type': 'application/json'}, 'endpoint': 'endpoint', 'received_at': '2024-10-22T18:07:21.843955Z', 'source': {'name': 'ansible.eda.webhook', 'type': 'ansible.eda.webhook'}, 'uuid': 'f27e21d6-dd63-4549-bd78-f9b93f454a4c'}}}]
2024-10-22 15:07:21,873 - ansible_rulebook.rule_set_runner - INFO - action args: {'name': 'hello-rh1.yml', 'extra_vars': {'hosts_update': 'gitlab.lnx.example.local'}}
2024-10-22 15:07:21,873 - ansible_rulebook.builtin - INFO - running Ansible playbook: hello-rh1.yml
2024-10-22 15:07:21,875 - ansible_rulebook.builtin - INFO - ruleset: Listen for events on a webhook, rule: Hello RH1
2024-10-22 15:07:21,875 - ansible_rulebook.builtin - INFO - Calling Ansible runner

PLAY [create env] **************************************************************

TASK [Gathering Facts] *********************************************************
ok: [localhost]

TASK [Add hosts] ***************************************************************
changed: [localhost] => (item=gitlab.lnx.example.local)

PLAY [Install centrifyDC Client] ***********************************************

TASK [Gathering Facts] *********************************************************
ok: [gitlab.lnx.example.local]

TASK [Uptime host test] ********************************************************
changed: [gitlab.lnx.example.local]

PLAY RECAP *********************************************************************
gitlab.lnx.example.local   : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
localhost                  : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
2024-10-22 15:07:40,528 - ansible_rulebook.builtin - INFO - Ansible Runner Queue task cancelled
2024-10-22 15:07:40,529 - ansible_rulebook.builtin - INFO - Playbook rc: 0, status: successful
2024-10-22 15:07:40,529 - ansible_rulebook.rule_set_runner - INFO - Task action::run_playbook::Listen for events on a webhook::Hello RH1 finished, active actions 0

----


[#guided_solution]
== Guided solution

Steps to be followed:

. Step 1
+
[source,bash]
----
command to be executed in the lab
----
+
.Output
----
Output displayed by the command
----

. Step 2

.. sub-step 2.1

.. sub-step 2.2

. Step 3


Let's copy the SSH settings to access the host:

[source,bash]
----
[lab-user@bastion ~]$ cd .ssh/
[lab-user@bastion .ssh]$ ls
authorized_keys  config  known_hosts  n66g5key.pem  n66g5key.pub
[lab-user@bastion .ssh]$ scp config n66g5key.p* ec2-user@node1:/home/ec2-user/.ssh/ 
config                                                                               100%  216   445.0KB/s   00:00    
n66g5key.pem                                                                         100% 2602     4.1MB/s   00:00    
n66g5key.pub                                                                         100%  552   878.2KB/s   00:00    
[lab-user@bastion .ssh]$ 
----

[source,bash]
----
[lab-user@bastion ~]$ ssh node1 
[ec2-user@node1 ~]$ cd 02-lab/
[ec2-user@node1 02-lab]$ ll
total 12
-rw-r--r--. 1 ec2-user ec2-user  86 Nov 18 13:57 hello-rh1.yml
-rw-r--r--. 1 ec2-user ec2-user  61 Nov 18 13:57 inventory.yml
-rw-r--r--. 1 ec2-user ec2-user 288 Nov 18 13:57 webhook-example.yml
----

We will need to edit the hello-rh1.yml file.

[source,bash]
----
[ec2-user@node1 02-lab]$ vim hello-rh1.yml
----

Change remote_user: root to remote_user: ec2-user

In the terminal where you created the files. Run ansible-rulebook:


[source,bash]
----
[ec2-user@node1 02-lab]$ ansible-rulebook --rulebook webhook-example.yml -i inventory.yml --verbose  --print-events
----



[source,bash]
----
[ec2-user@node1 02-lab]$ ansible-rulebook --rulebook webhook-example.yml -i inventory.yml --verbose  --print-events 
2024-11-18 20:15:27,185 - ansible_rulebook.app - INFO - Starting sources
2024-11-18 20:15:27,186 - ansible_rulebook.app - INFO - Starting rules
2024-11-18 20:15:27,187 - drools.ruleset - INFO - Using jar: /usr/lib/python3.9/site-packages/drools/jars/drools-ansible-rulebook-integration-runtime-1.0.6.Final-redhat-00001.jar
2024-11-18 20:15:28 511 [main] INFO org.drools.ansible.rulebook.integration.api.rulesengine.AbstractRulesEvaluator - Start automatic pseudo clock with a tick every 100 milliseconds
2024-11-18 20:15:28,544 - ansible_rulebook.engine - INFO - load source ansible.eda.webhook
2024-11-18 20:15:29,415 - ansible_rulebook.engine - INFO - loading source filter eda.builtin.insert_meta_info
2024-11-18 20:15:30,234 - ansible_rulebook.engine - INFO - Waiting for all ruleset tasks to end
2024-11-18 20:15:30,235 - ansible_rulebook.rule_set_runner - INFO - Waiting for actions on events from Listen for events on a webhook
2024-11-18 20:15:30,235 - ansible_rulebook.rule_set_runner - INFO - Waiting for events, ruleset: Listen for events on a webhook
2024-11-18 20:15:30 236 [drools-async-evaluator-thread] INFO org.drools.ansible.rulebook.integration.api.io.RuleExecutorChannel - Async channel connected

----

In another terminal, run the curl command:

[source,bash]
----
  curl -H 'Content-Type: application/json' -d '{"event_name": "Hello", "host_host": "node1" }' node1:5000/endpoint
----

In the terminal where you executed the rulebook command. You will get this output:

Now, You have two vars: event_name and host_host.


[source,bash]
----
2024-10-22 15:05:30,506 - ansible_rulebook.app - INFO - Starting sources
2024-10-22 15:05:30,506 - ansible_rulebook.app - INFO - Starting rules
2024-10-22 15:05:30,506 - ansible_rulebook.engine - INFO - run_ruleset
2024-10-22 15:05:30,506 - drools.ruleset - INFO - Using jar: /usr/local/lib/python3.9/site-packages/drools/jars/drools-ansible-rulebook-integration-runtime-1.0.2-SNAPSHOT.jar
2024-10-22 15:05:30 841 [main] INFO org.drools.ansible.rulebook.integration.api.rulesengine.AbstractRulesEvaluator - Start automatic pseudo clock with a tick every 100 milliseconds
2024-10-22 15:05:30,844 - ansible_rulebook.engine - INFO - ruleset define: {"name": "Listen for events on a webhook", "hosts": ["all"], "sources": [{"EventSource": {"name": "ansible.eda.webhook", "source_name": "ansible.eda.webhook", "source_args": {"host": "0.0.0.0", "port": 5000}, "source_filters": []}}], "rules": [{"Rule": {"name": "Hello RH1", "condition": {"AllCondition": [{"EqualsExpression": {"lhs": {"Event": "payload.event_name"}, "rhs": {"String": "Hello"}}}]}, "actions": [{"Action": {"action": "run_playbook", "action_args": {"name": "hello-rh1.yml", "extra_vars": {"hosts_update": "{{ event.payload.host_host }}"}}}}], "enabled": true}}]}
2024-10-22 15:05:30,852 - ansible_rulebook.engine - INFO - load source
2024-10-22 15:05:31,061 - ansible_rulebook.engine - INFO - load source filters
2024-10-22 15:05:31,061 - ansible_rulebook.engine - INFO - loading eda.builtin.insert_meta_info
2024-10-22 15:05:31,260 - ansible_rulebook.engine - INFO - Calling main in ansible.eda.webhook
2024-10-22 15:05:31,262 - ansible_rulebook.engine - INFO - Waiting for all ruleset tasks to end
2024-10-22 15:05:31,262 - ansible_rulebook.rule_set_runner - INFO - Waiting for actions on events from Listen for events on a webhook
2024-10-22 15:05:31,262 - ansible_rulebook.rule_set_runner - INFO - Waiting for events, ruleset: Listen for events on a webhook
2024-10-22 15:05:31 262 [drools-async-evaluator-thread] INFO org.drools.ansible.rulebook.integration.api.io.RuleExecutorChannel - Async channel connected
2024-10-22 15:07:21,844 - aiohttp.access - INFO - 127.0.0.1 [22/Oct/2024:18:07:21 +0000] "POST /endpoint HTTP/1.1" 200 158 "-" "curl/7.61.1"
{   'meta': {   'endpoint': 'endpoint',
                'headers': {   'Accept': '*/*',
                               'Content-Length': '65',
                               'Content-Type': 'application/json',
                               'Host': 'localhost:5000',
                               'User-Agent': 'curl/7.61.1'},
                'received_at': '2024-10-22T18:07:21.843955Z',
                'source': {   'name': 'ansible.eda.webhook',
                              'type': 'ansible.eda.webhook'},
                'uuid': 'f27e21d6-dd63-4549-bd78-f9b93f454a4c'},
    'payload': {'event_name': 'Hello', 'host_host': 'gitlab.lnx.example.local'}}
2024-10-22 15:07:21 864 [main] INFO org.drools.ansible.rulebook.integration.api.rulesengine.RegisterOnlyAgendaFilter - Activation of effective rule "Hello RH1" with facts: {m={payload={host_host=gitlab.lnx.example.local, event_name=Hello}, meta={headers={Accept=*/*, User-Agent=curl/7.61.1, Host=localhost:5000, Content-Length=65, Content-Type=application/json}, endpoint=endpoint, received_at=2024-10-22T18:07:21.843955Z, source={name=ansible.eda.webhook, type=ansible.eda.webhook}, uuid=f27e21d6-dd63-4549-bd78-f9b93f454a4c}}}
2024-10-22 15:07:21,870 - ansible_rulebook.rule_generator - INFO - calling Hello RH1
2024-10-22 15:07:21,870 - ansible_rulebook.rule_set_runner - INFO - call_action run_playbook
2024-10-22 15:07:21,870 - ansible_rulebook.rule_set_runner - INFO - substitute_variables [{'name': 'hello-rh1.yml', 'extra_vars': {'hosts_update': '{{ event.payload.host_host }}'}}] [{'event': {'payload': {'host_host': 'gitlab.lnx.example.local', 'event_name': 'Hello'}, 'meta': {'headers': {'Accept': '*/*', 'User-Agent': 'curl/7.61.1', 'Host': 'localhost:5000', 'Content-Length': '65', 'Content-Type': 'application/json'}, 'endpoint': 'endpoint', 'received_at': '2024-10-22T18:07:21.843955Z', 'source': {'name': 'ansible.eda.webhook', 'type': 'ansible.eda.webhook'}, 'uuid': 'f27e21d6-dd63-4549-bd78-f9b93f454a4c'}}}]
2024-10-22 15:07:21,873 - ansible_rulebook.rule_set_runner - INFO - action args: {'name': 'hello-rh1.yml', 'extra_vars': {'hosts_update': 'gitlab.lnx.example.local'}}
2024-10-22 15:07:21,873 - ansible_rulebook.builtin - INFO - running Ansible playbook: hello-rh1.yml
2024-10-22 15:07:21,875 - ansible_rulebook.builtin - INFO - ruleset: Listen for events on a webhook, rule: Hello RH1
2024-10-22 15:07:21,875 - ansible_rulebook.builtin - INFO - Calling Ansible runner

PLAY [create env] **************************************************************

TASK [Gathering Facts] *********************************************************
ok: [localhost]

TASK [Add hosts] ***************************************************************
changed: [localhost] => (item=gitlab.lnx.example.local)

PLAY [Install centrifyDC Client] ***********************************************

TASK [Gathering Facts] *********************************************************
ok: [gitlab.lnx.example.local]

TASK [Uptime host test] ********************************************************
changed: [gitlab.lnx.example.local]

PLAY RECAP *********************************************************************
gitlab.lnx.example.local   : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
localhost                  : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
2024-10-22 15:07:40,528 - ansible_rulebook.builtin - INFO - Ansible Runner Queue task cancelled
2024-10-22 15:07:40,529 - ansible_rulebook.builtin - INFO - Playbook rc: 0, status: successful
2024-10-22 15:07:40,529 - ansible_rulebook.rule_set_runner - INFO - Task action::run_playbook::Listen for events on a webhook::Hello RH1 finished, active actions 0

----

